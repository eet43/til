# DDD, MSA

## DDD란 ?
도메인 주도적 설계 (Domain-Driven-Design) 으로 프로그램을 설계할 때 도메인 단위로 설계하는 것을 의미한다.<br><br>
도메인이란 소프트웨어로 해결하고자 하는 문제의 영역, 개발하고자 하는 전체 서비스를 잘라낸 단위를 의미한다. <br><br>
DDD의 핵심 기본 요소는 바로 Loose Coupling (느슨한 결합도) 과 High Cohesion (높은 응집도) 이다. <br><br>

### 느슨한 결합? 높은 응집도 ?
<img width="396" alt="07" src="https://user-images.githubusercontent.com/59008469/170444614-dfe0050e-c395-4ca8-9db1-371d05809239.png">
<br><br>
도메인 내에서는 높은 응집도를 유지하며, 도메인들 간에는느슨한 결합도를 유지하게 끔 설계하는 것이 DDD 의 핵심이다.<br><br>
때문에 가장 중요한 것은 도메인을 적절하게 구분 짓는 것이 매우 중요하다.<br><br>
무작정 도메인 단위를 잘게 나눈다고 해서 능사가 아닌, 어떤 서비스들을 하나의 도메인으로 묶어 도메인 내에서 높은 응집도를 유지할 것인가
또한 고민해야 한다.<br><br>

## MSA란 ?
MSA는 DDD를 기반으로 아키텍처 패턴을 정의한 것이다. <br><br>
위 DDD의 설계 원칙(Loose Coupling과 High Cohesion)을 MSA에 적용하면, 도메인 내 마이크로서비스와 도메인 외부 마이크로서비스로 구분될 것이고, 내부 인터페이스인지 외부 인터페이스인지에 따라 마이크로서비스들 간의 커뮤니케이션 방식, 즉 설계 원칙이 달라질 것이다. <br><br>

즉, 위 그림의 예를 들면, Domain A 내 마이크로서비스들은 API 기반의 Sync Call이나 같은 DB를 바라 볼 것이다.<br><br>
반대로 Domain A에 있는 마이크로서비스가 Domain B의 마이크로서비스들과 커뮤니케이션 하기 위해서는 Async 방식의 메시지 기반 통신을 수행하고 DB도 분리되어야 할 것이다.<br><br>

<img width="837" alt="08" src="https://user-images.githubusercontent.com/59008469/170446443-9ee283d1-ae2e-4b86-b4b8-39cf475e2542.png"> <br><br>
각각의 마이크로 서비스들이 별개의 인스턴스로 로딩될 것이다. 저희가 배운 클라우드 시스템에 아주 적합한 아키텍처 설계이다.<br><br>
서비스 별 저장소를 분리해서 다른 서비스가 저장소를 직접 호출할 수 없고, API 로 접근하는 방법 밖에 없다.<br><br>
또한 각각의 서비스 배포는 비즈니스 기능 단위로 구성되며, CI/CD 자동화된 배포 방식을 이용하여 독립적으로 배포된다.<br><br>

## 데이터 중복
이러한 구조에서는 비즈니스 처리를 위해 일부 데이터의 중복, 복제 허용이 필요하다. 때문에 여기서 데이터 일관성 문제가 발생한다.<br><br>
데이터 일관성 처리를 위해서 보통 2단계 커밋 같은 분산 트랙잭션 기법을 사용해야 다. 하지만 nosql 같은 2단계 커밋을 지원하지 않는 경우도 있다. 때문에 보통은 비동기 이벤트 처리를 강조한다.<br><br>
여러 트랜잭션을 하나로 묶지 않고, 별도의 로컬 트랜잭션을 각각 수행하고, 데이터의 일관성이 달라지는 부분을 체크해서 보상 트랜잭션으로 일관성을 맞춰주는 개념이다.<br><br>
요즘은 트랜잭션을 분리하고 큐 메커니즘을 이용하여 보상 트랜잭션을 활용한다고 한다.<br><br>
<img width="837" alt="09" src="https://user-images.githubusercontent.com/59008469/170450092-a87b35ce-eebd-4299-86da-14ee6562759e.png"><br><br>

각각 서버들의 통신은 메시지 큐에서 이루어진다.<br><br>

어려운 내용이라 자세한 건 Saga Pattern 을 공부하시면 될 것 같다.<br><br>
https://blog.neonkid.xyz/243

<br><br>

## 그래서 어떻게 설계하라는거야
### 객체와 도메인은 다르다 !
객체와 도메인의 개념은 비슷하지만 대상 범위에 차이가 있다.

## 후기
미약하게나마 모든 요소를 만족하지 못 하였지만, MSA 패턴을 적용해서 개발해보았다.<br><br>
결론은 어설프게 할 거면 안하느니만 못하다 이다.<br><br>
깃 충돌날 일이 거의 없고, 비즈니스 모델에 맞게 독립적으로 운영할 수 있다는 점은 분명 큰 메리트가 있다.<br><br>
하지만 설정하기 너무 까다로우며, 테스트하기 매우 불편하고, 설계가 자칫 잘못되면 쉬운 기능도 엄청 돌고 돌아서 간다..<br><br>
기업에서 실무를 겪으며 많이 배우고 적용해야 할 거 같다는 결론이다 ..<br><br>

